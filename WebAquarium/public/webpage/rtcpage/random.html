<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Random Matching - Waiting Room</title>
    <link rel="stylesheet" href="random.css">
</head>
<body>
    <div class="container">
        <h1>Random</h1>
        <p id="statusMessage">We will find your friend, wait for few minute...</p>
        <div class="loading" id="spinner">
            <div class="spinner"></div>
        </div>
        <button class="btn" id="actionButton">cancle</button>
    </div>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script>
        let socket = null;
        let room = null;
        let isCaller = false;
        let pairingActive = false;
        const statusMessage = document.getElementById("statusMessage");
        const spinner = document.getElementById("spinner");
        const actionButton = document.getElementById("actionButton");

        function startPairing() {
            socket = io("https://webrtc-deploy.onrender.com", { transports: ["websocket"] });
            pairingActive = true;
            statusMessage.innerText = "We will find your friend, wait for few minute...";
            actionButton.innerText = "cancle";
            spinner.style.display = "block";
            spinner.style.animation = "spin 1s linear infinite";
            statusMessage.classList.remove("paired");

            socket.emit("join-random", (response) => {
                if (response.success) {
                    room = response.room;
                    if (response.waiting) {
                        isCaller = true;
                        console.log("Waiting for partner, room:", room);
                    } else {
                        isCaller = false;
                        console.log("Partner found, room:", room);
                        redirectToCall();
                    }
                } else {
                    alert("Error: " + response.message);
                }
            });

            socket.on("room-ready", (roomId) => {
                if (roomId === room) {
                    console.log("Room is ready:", roomId);
                    statusMessage.innerText = "Found your friend! Connecting...";
                    statusMessage.classList.add("paired");
                    spinner.style.animation = "fadeOut 1s forwards";
                    setTimeout(() => {
                        redirectToCall();
                    }, 1500);
                }
            });

            socket.on("room-timeout", (roomId) => {
                if (roomId === room) {
                    statusMessage.innerText = "No one is available right now, please try again later.";
                    spinner.style.animation = "fadeOut 1s forwards";
                    actionButton.innerText = "start";
                    pairingActive = false;
                }
            });
        }

        function redirectToCall() {
            sessionStorage.setItem("room", room);
            sessionStorage.setItem("isCaller", isCaller);
            window.location.href = "webRTC.html";
        }

        function cancelPairing() {
            if (socket) {
                socket.disconnect();
                socket = null;
            }
            pairingActive = false;
            room = null;
            isCaller = false;
            statusMessage.innerText = "จับคู่ถูกยกเลิกแล้ว";
            spinner.style.display = "none";
            actionButton.innerText = "เริ่ม";
        }

        startPairing();

        actionButton.onclick = () => {
            if (pairingActive) {
                cancelPairing();
            } else {
                startPairing();
            }
        };
    </script>
</body>
</html>